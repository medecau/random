#!/usr/bin/env python
"""
This script is used to suggest a commit message by sending the diff
to an openai api endpoint. The api endpoint does GPT-3 completion
on the diff and returns a commit message suggestion.
"""

import subprocess
import argparse
import json
import os
import sys
import urllib.request


def http_request(method, url, data, headers):
    """Send a http request and return the response body."""
    req = urllib.request.Request(url, data=data, headers=headers, method=method)
    response = urllib.request.urlopen(req)
    body = response.read().decode("utf-8")
    return json.loads(body)


def main():
    # get the diff
    diff = subprocess.check_output(["git", "diff", "--cached"]).decode("utf-8")

    # get the necessary credentials
    openai_api_key = os.environ["OPENAI_API_KEY"]
    openai_api_endpoint = os.environ["OPENAI_API_ENDPOINT"]

    # request body
    data = json.dumps(
        {
            "prompt": diff,
            "max_tokens": 100,
            "temperature": 0.9,
            "top_p": 0.9,
        }
    ).encode("utf-8")

    # request headers
    headers = {
        "Content-Type": "application/json",
        "Content-Length": len(data),
        "Authorization": f"Bearer {openai_api_key}",
    }

    # send the diff to the openai api endpoint
    req = urllib.request.Request(
        openai_api_endpoint, data=data, headers=headers, method="POST"
    )
    response = urllib.request.urlopen(req)
    response_body = json.loads(response.read().decode("utf-8"))

    # print the response
    print(response_body["choices"][0]["text"])
